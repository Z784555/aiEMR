# åŒ»ç–—AIå¯¼è¯Šç³»ç»Ÿ - æ•´åˆæ–‡æ¡£ï¼ˆä¾èµ–å’Œç±»ä¿¡æ¯ï¼‰

## ğŸ“¦ ä¸€ã€Mavenä¾èµ–æ¸…å•

### æ ¸å¿ƒä¾èµ–ï¼ˆdemo99/pom.xmlï¼‰

```xml
<dependencies>
    <!-- MyBatis-Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-jsqlparser</artifactId>
    </dependency>
    
    <!-- MySQLé©±åŠ¨ -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
    
    <!-- Druidæ•°æ®æº -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.2.24</version>
    </dependency>
    
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring AI (OpenAI) -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-openai</artifactId>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>annotationProcessor</scope>
    </dependency>
    
    <!-- Spring Boot DevTools -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-devtools</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

### çˆ¶POMç‰ˆæœ¬ä¿¡æ¯
- Spring Boot: `3.2.4`
- Spring AI: `1.0.3`
- MyBatis-Plus: `3.5.14`
- JDK: `17`

---

## ğŸ—ï¸ äºŒã€ç±»ç»“æ„æ¸…å•

### 1. å¯åŠ¨ç±»
```
com.neusoft.neu23.Demo99App
```
- **ä½œç”¨**: Spring Bootåº”ç”¨ä¸»å¯åŠ¨ç±»
- **ç«¯å£**: 18080
- **åŒ…æ‰«æ**: `@MapperScan("com.neusoft.neu23.mapper")`

---

### 2. å®ä½“ç±»ï¼ˆEntityï¼‰

#### 2.1 Patientï¼ˆæ‚£è€…ï¼‰
```
com.neusoft.neu23.entity.Patient
```
- **è¡¨å**: `patient`
- **ä¸»é”®**: `patient_id` (INT, AUTO_INCREMENT)
- **å­—æ®µ**:
  - `patientId`: æ‚£è€…ç¼–å·
  - `name`: æ‚£è€…å§“å (VARCHAR(50))
  - `phone`: æ‚£è€…æ‰‹æœºå· (VARCHAR(20))
  - `age`: æ‚£è€…å¹´é¾„ (INT)
  - `gender`: æ‚£è€…æ€§åˆ« (INT, 0-å¥³, 1-ç”·)
  - `symptoms`: ä¸»è¦ç—‡çŠ¶æè¿° (TEXT)

#### 2.2 Departmentï¼ˆç§‘å®¤ï¼‰
```
com.neusoft.neu23.entity.Department
```
- **è¡¨å**: `department`
- **ä¸»é”®**: `dept_id` (INT, AUTO_INCREMENT)
- **å­—æ®µ**:
  - `deptId`: ç§‘å®¤ç¼–å·
  - `deptName`: ç§‘å®¤åç§° (VARCHAR(50))
  - `description`: ç§‘å®¤æè¿° (TEXT)
  - `mainSymptoms`: ç§‘å®¤ä¸»æ²»ç—‡çŠ¶ (TEXT)

#### 2.3 Doctorï¼ˆåŒ»ç”Ÿï¼‰
```
com.neusoft.neu23.entity.Doctor
```
- **è¡¨å**: `doctor`
- **ä¸»é”®**: `doctor_id` (INT, AUTO_INCREMENT)
- **å­—æ®µ**:
  - `doctorId`: åŒ»ç”Ÿç¼–å·
  - `name`: åŒ»ç”Ÿå§“å (VARCHAR(50))
  - `deptId`: æ‰€å±ç§‘å®¤ç¼–å· (INT, FK)
  - `title`: åŒ»ç”ŸèŒç§° (VARCHAR(50))
  - `specialty`: æ“…é•¿é¢†åŸŸ (VARCHAR(200))
  - `isAvailable`: æ˜¯å¦åœ¨è¯Š (INT, 0-ä¸åœ¨è¯Š, 1-åœ¨è¯Š)
  - `scheduleDate`: åè¯Šæ—¥æœŸ (VARCHAR(20), YYYY-MM-DD)
  - `scheduleTime`: åè¯Šæ—¶é—´æ®µ (VARCHAR(20))

#### 2.4 Registrationï¼ˆæŒ‚å·è®°å½•ï¼‰
```
com.neusoft.neu23.entity.Registration
```
- **è¡¨å**: `registration`
- **ä¸»é”®**: `registration_id` (INT, AUTO_INCREMENT)
- **å­—æ®µ**:
  - `registrationId`: æŒ‚å·ç¼–å·
  - `patientId`: æ‚£è€…ç¼–å· (INT, FK)
  - `doctorId`: åŒ»ç”Ÿç¼–å· (INT, FK)
  - `deptId`: ç§‘å®¤ç¼–å· (INT, FK)
  - `appointmentDate`: æŒ‚å·æ—¥æœŸ (VARCHAR(20))
  - `appointmentTime`: æŒ‚å·æ—¶é—´æ®µ (VARCHAR(20))
  - `status`: æŒ‚å·çŠ¶æ€ (INT, 0-å·²å–æ¶ˆ, 1-å·²é¢„çº¦, 2-å·²å®Œæˆ)

---

### 3. Mapperæ¥å£ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰

```
com.neusoft.neu23.mapper.PatientMapper
com.neusoft.neu23.mapper.DepartmentMapper
com.neusoft.neu23.mapper.DoctorMapper
com.neusoft.neu23.mapper.RegistrationMapper
```

- **ç»§æ‰¿**: `BaseMapper<T>` (MyBatis-Plus)
- **ä½œç”¨**: æä¾›åŸºç¡€CRUDæ“ä½œ

---

### 4. Serviceæ¥å£å’Œå®ç°ï¼ˆä¸šåŠ¡å±‚ï¼‰

#### 4.1 PatientService
```
æ¥å£: com.neusoft.neu23.service.PatientService
å®ç°: com.neusoft.neu23.service.impl.PatientServiceImpl
```
- `Integer addPatient(Patient patient)` - æ·»åŠ æ‚£è€…
- `Patient getPatientById(Integer patientId)` - æ ¹æ®IDæŸ¥è¯¢æ‚£è€…

#### 4.2 DepartmentService
```
æ¥å£: com.neusoft.neu23.service.DepartmentService
å®ç°: com.neusoft.neu23.service.impl.DepartmentServiceImpl
```
- `List<Department> findDepartmentsBySymptoms(String symptoms)` - æ ¹æ®ç—‡çŠ¶æŸ¥è¯¢ç§‘å®¤
- `Department getDepartmentByName(String deptName)` - æ ¹æ®åç§°æŸ¥è¯¢ç§‘å®¤
- `List<Department> getAllDepartments()` - æŸ¥è¯¢æ‰€æœ‰ç§‘å®¤

#### 4.3 DoctorService
```
æ¥å£: com.neusoft.neu23.service.DoctorService
å®ç°: com.neusoft.neu23.service.impl.DoctorServiceImpl
```
- `List<Doctor> findAvailableDoctors(Integer deptId, String date)` - æŸ¥è¯¢å¯ç”¨åŒ»ç”Ÿ
- `List<Doctor> findDoctorsByDeptId(Integer deptId)` - æ ¹æ®ç§‘å®¤æŸ¥è¯¢åŒ»ç”Ÿ
- `Doctor getDoctorById(Integer doctorId)` - æ ¹æ®IDæŸ¥è¯¢åŒ»ç”Ÿ

#### 4.4 RegistrationService
```
æ¥å£: com.neusoft.neu23.service.RegistrationService
å®ç°: com.neusoft.neu23.service.impl.RegistrationServiceImpl
```
- `Integer createRegistration(Registration registration)` - åˆ›å»ºæŒ‚å·è®°å½•
- `Registration getRegistrationById(Integer registrationId)` - æ ¹æ®IDæŸ¥è¯¢æŒ‚å·

---

### 5. Controllerï¼ˆæ§åˆ¶å™¨å±‚ï¼‰

#### 5.1 Demo99Controllerï¼ˆä¸»è¦æ§åˆ¶å™¨ï¼‰
```
com.neusoft.neu23.controller.Demo99Controller
```
- **è¯·æ±‚è·¯å¾„**: `/d`
- **è·¨åŸŸæ”¯æŒ**: `@CrossOrigin`
- **ä¸»è¦æ¥å£**:
  - `GET /d/c1` - åŒ»ç–—AIå¯¼è¯Šæ¥å£
    - å‚æ•°: `msg` (æ‚£è€…æ¶ˆæ¯), `chatId` (ä¼šè¯ID)
    - è¿”å›: AIåŠ©æ‰‹å›å¤ï¼ˆStringï¼‰

---

### 6. é…ç½®ç±»ï¼ˆConfigurationï¼‰

#### 6.1 AiConfig
```
com.neusoft.neu23.cfg.AiConfig
```
- **ä½œç”¨**: Spring AIé…ç½®
- **ä¾èµ–æ³¨å…¥**:
  - `ChatMemory` - å¯¹è¯è®°å¿†ç®¡ç†
  - `OpenAiChatModel` - OpenAIæ¨¡å‹
- **å¸¸é‡**:
  - `TOOLCALLING_PROMPT` - åŒ»ç–—å¯¼è¯Šç³»ç»Ÿæç¤ºè¯

---

### 7. Toolç±»ï¼ˆAIå·¥å…·ï¼‰

#### 7.1 MedicalToolsï¼ˆåŒ»ç–—å¯¼è¯Šå·¥å…·ï¼‰
```
com.neusoft.neu23.tc.MedicalTools
```
- **ä½œç”¨**: æä¾›ç»™AIè°ƒç”¨çš„å·¥å…·å‡½æ•°
- **å·¥å…·æ–¹æ³•**:
  - `savePatientInfo()` - ä¿å­˜æ‚£è€…ä¿¡æ¯
  - `findDepartmentsBySymptoms()` - æ ¹æ®ç—‡çŠ¶æŸ¥è¯¢ç§‘å®¤
  - `getDepartmentByName()` - æ ¹æ®åç§°æŸ¥è¯¢ç§‘å®¤
  - `getAllDepartments()` - æŸ¥è¯¢æ‰€æœ‰ç§‘å®¤
  - `findAvailableDoctors()` - æŸ¥è¯¢å¯ç”¨åŒ»ç”Ÿ
  - `findDoctorsByDeptId()` - æ ¹æ®ç§‘å®¤æŸ¥è¯¢åŒ»ç”Ÿ
  - `createRegistration()` - å®ŒæˆæŒ‚å·
  - `getPatientById()` - æŸ¥è¯¢æ‚£è€…ä¿¡æ¯
  - `getDoctorById()` - æŸ¥è¯¢åŒ»ç”Ÿä¿¡æ¯

#### 7.2 DateTimeToolsï¼ˆæ—¶é—´å·¥å…·ï¼‰
```
com.neusoft.neu23.tc.DateTimeTools
```
- `getCurrentDateTime()` - è·å–å½“å‰æ—¥æœŸæ—¶é—´

---

## ğŸŒ ä¸‰ã€APIæ¥å£ä¿¡æ¯

### ä¸»è¦æ¥å£

#### åŒ»ç–—AIå¯¼è¯Šæ¥å£
```
GET /d/c1
```

**è¯·æ±‚å‚æ•°**:
- `msg` (String, å¯é€‰, é»˜è®¤: "ä½ å¥½ï¼Œæˆ‘éœ€è¦çœ‹ç—…") - æ‚£è€…è¾“å…¥çš„æ¶ˆæ¯
- `chatId` (String, å¯é€‰, é»˜è®¤: "medical-consultation") - ä¼šè¯IDï¼Œç”¨äºä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡

**å“åº”**:
- ç±»å‹: `String`
- å†…å®¹: AIåŠ©æ‰‹çš„å›å¤ï¼ˆHTMLæ ¼å¼ï¼Œå¯èƒ½åŒ…å«è¡¨æ ¼ï¼‰

**ç¤ºä¾‹è¯·æ±‚**:
```
GET http://localhost:18080/d/c1?msg=ä½ å¥½ï¼Œæˆ‘éœ€è¦çœ‹ç—…&chatId=user-001
```

**ç¤ºä¾‹å“åº”**:
```
æ‚¨å¥½ï¼æˆ‘æ˜¯åŒ»ç–—AIå¯¼è¯ŠåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„ä¸»è¦ç—‡çŠ¶ï¼Œæˆ‘ä¼šå¸®æ‚¨æ¨èåˆé€‚çš„ç§‘å®¤...
```

---

## âš™ï¸ å››ã€é…ç½®æ–‡ä»¶ä¿¡æ¯

### application.yaml

```yaml
server:
  port: 18080

spring:
  # Spring AIé…ç½®
  ai:
    openai:
      api-key: sk-d1022725fada4052825318244e6ca73b
      base-url: https://api.deepseek.com
      chat:
        options:
          model: deepseek-chat
          temperature: 0.8

  # æ•°æ®åº“é…ç½®
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/aihis?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&allowPublicKeyRetrieval=true&useSSL=false
    username: root
    password: root
    type: com.alibaba.druid.pool.DruidDataSource

# MyBatis-Plusé…ç½®
mybatis-plus:
  type-aliases-package: com.neusoft.neu23.entity
  mapper-locations: classpath*:mapper/*.xml

# æ—¥å¿—é…ç½®
logging:
  level:
    root: debug
    org.springframework.ai.chat.client: error
    com.neusoft.neu23.mapper: debug
```

---

## ğŸ—„ï¸ äº”ã€æ•°æ®åº“è¡¨ç»“æ„

### æ•°æ®åº“å: `aihis`

#### 1. patientï¼ˆæ‚£è€…è¡¨ï¼‰
```sql
CREATE TABLE `patient` (
  `patient_id` INT AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(50) NOT NULL,
  `phone` VARCHAR(20) NOT NULL,
  `age` INT,
  `gender` INT,
  `symptoms` TEXT,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. departmentï¼ˆç§‘å®¤è¡¨ï¼‰
```sql
CREATE TABLE `department` (
  `dept_id` INT AUTO_INCREMENT PRIMARY KEY,
  `dept_name` VARCHAR(50) NOT NULL,
  `description` TEXT,
  `main_symptoms` TEXT
);
```

#### 3. doctorï¼ˆåŒ»ç”Ÿè¡¨ï¼‰
```sql
CREATE TABLE `doctor` (
  `doctor_id` INT AUTO_INCREMENT PRIMARY KEY,
  `name` VARCHAR(50) NOT NULL,
  `dept_id` INT NOT NULL,
  `title` VARCHAR(50),
  `specialty` VARCHAR(200),
  `is_available` INT DEFAULT 1,
  `schedule_date` VARCHAR(20),
  `schedule_time` VARCHAR(20),
  FOREIGN KEY (`dept_id`) REFERENCES `department`(`dept_id`)
);
```

#### 4. registrationï¼ˆæŒ‚å·è¡¨ï¼‰
```sql
CREATE TABLE `registration` (
  `registration_id` INT AUTO_INCREMENT PRIMARY KEY,
  `patient_id` INT NOT NULL,
  `doctor_id` INT NOT NULL,
  `dept_id` INT NOT NULL,
  `appointment_date` VARCHAR(20) NOT NULL,
  `appointment_time` VARCHAR(20),
  `status` INT DEFAULT 1,
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`patient_id`) REFERENCES `patient`(`patient_id`),
  FOREIGN KEY (`doctor_id`) REFERENCES `doctor`(`doctor_id`),
  FOREIGN KEY (`dept_id`) REFERENCES `department`(`dept_id`)
);
```

---

## ğŸ”— å…­ã€ç½‘å…³æ•´åˆå»ºè®®

### 1. è·¯ç”±é…ç½®
```yaml
# Spring Cloud Gatewayé…ç½®ç¤ºä¾‹
spring:
  cloud:
    gateway:
      routes:
        - id: medical-ai-service
          uri: http://localhost:18080
          predicates:
            - Path=/api/medical/**
          filters:
            - StripPrefix=2
```

### 2. æœåŠ¡æ³¨å†Œï¼ˆå¦‚æœä½¿ç”¨Nacosï¼‰
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        service-name: medical-ai-service
```

### 3. è·¨åŸŸé…ç½®
- å½“å‰Controllerå·²é…ç½® `@CrossOrigin`
- ç½‘å…³å±‚ä¹Ÿéœ€è¦é…ç½®CORS

---

## ğŸ¨ ä¸ƒã€å‰ç«¯æ•´åˆå»ºè®®

### 1. APIè°ƒç”¨ç¤ºä¾‹ï¼ˆJavaScript/Axiosï¼‰
```javascript
// å‘é€æ¶ˆæ¯
async function sendMessage(msg, chatId) {
  const response = await axios.get('http://gateway:port/api/medical/d/c1', {
    params: {
      msg: msg,
      chatId: chatId || 'user-' + Date.now()
    }
  });
  return response.data;
}

// ä½¿ç”¨ç¤ºä¾‹
sendMessage('ä½ å¥½ï¼Œæˆ‘éœ€è¦çœ‹ç—…', 'user-001')
  .then(reply => {
    console.log('AIå›å¤:', reply);
    // æ›´æ–°UIæ˜¾ç¤ºå›å¤
  });
```

### 2. WebSocketæ”¯æŒï¼ˆå¯é€‰ï¼‰
- å½“å‰ä½¿ç”¨HTTP GETè¯·æ±‚
- å¦‚éœ€å®æ—¶å¯¹è¯ï¼Œå¯è€ƒè™‘å‡çº§ä¸ºWebSocket

### 3. å“åº”æ ¼å¼
- AIè¿”å›çš„æ˜¯HTMLæ ¼å¼çš„å­—ç¬¦ä¸²
- å¯èƒ½åŒ…å«è¡¨æ ¼ï¼ˆ`<table>`, `<tr>`, `<td>`ï¼‰
- å‰ç«¯éœ€è¦æ”¯æŒHTMLæ¸²æŸ“

---

## ğŸ“‹ å…«ã€å…³é”®ä¾èµ–æ³¨å…¥å…³ç³»

```
Demo99Controller
  â”œâ”€â”€ OpenAiChatModel (Spring AIè‡ªåŠ¨é…ç½®)
  â”œâ”€â”€ ChatMemory (Spring AIè‡ªåŠ¨é…ç½®)
  â”œâ”€â”€ DateTimeTools (@Component)
  â””â”€â”€ MedicalTools (@Component)
      â”œâ”€â”€ PatientService
      â”œâ”€â”€ DepartmentService
      â”œâ”€â”€ DoctorService
      â””â”€â”€ RegistrationService
          â””â”€â”€ å¯¹åº”çš„Mapper (MyBatis-Plus)
```

---

## âš ï¸ ä¹ã€æ³¨æ„äº‹é¡¹

1. **ç«¯å£**: å½“å‰æœåŠ¡ç«¯å£ä¸º `18080`ï¼Œç½‘å…³æ•´åˆæ—¶æ³¨æ„ç«¯å£æ˜ å°„
2. **è·¯å¾„**: å½“å‰æ¥å£è·¯å¾„ä¸º `/d/c1`ï¼Œç½‘å…³å¯èƒ½éœ€è¦è·¯å¾„é‡å†™
3. **ä¼šè¯ç®¡ç†**: ä½¿ç”¨ `chatId` å‚æ•°ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå‰ç«¯éœ€è¦ç»´æŠ¤æ­¤ID
4. **APIå¯†é’¥**: DeepSeek APIå¯†é’¥éœ€è¦é…ç½®ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒ
5. **æ•°æ®åº“**: éœ€è¦å…ˆæ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨å’Œåˆå§‹æ•°æ®

---

## ğŸ“ åã€è”ç³»æ–¹å¼

å¦‚æœ‰æ•´åˆé—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- ä»£ç ä½ç½®: `demo99/` ç›®å½•
- SQLè„šæœ¬: `demo99/src/main/resources/sql/init.sql`
- è¿è¡Œè¯´æ˜: `demo99/README_è¿è¡Œè¯´æ˜.md`

